#! /bin/sh
# postinst script for xivo-ctid
#
# see: dh_installdeb(1)

set -e

MASTER_TOKEN_FILE="/usr/lib/consul/master_token"
CONSUL_CONFIG_FILE="/etc/consul/config.json"

case "$1" in
    configure)
	if [ ! -f ${MASTER_TOKEN_FILE} ]; then
	    touch ${MASTER_TOKEN_FILE}
	    chmod 600 ${MASTER_TOKEN_FILE}
	    token=$(od -An -tx4 -N32 -w /dev/urandom | tr -d " ")
	    echo ${token} > ${MASTER_TOKEN_FILE}
	fi

	if [ ! -f ${CONSUL_CONFIG_FILE} ]; then
	    touch ${CONSUL_CONFIG_FILE}
	    chmod 600 ${CONSUL_CONFIG_FILE}
	    token=$(cat ${MASTER_TOKEN_FILE})
	    cat > ${CONSUL_CONFIG_FILE} <<EOF
{
    "acl_default_policy": "deny",
    "acl_master_token": "${token}",
    "acl_datacenter": "$(hostname)"
}
EOF
	fi
    ;;
    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
